@model TourBookingPageViewModel
@using Models.Helper
@using Models.Entities

@{
    var form = Model.Form ?? new TourReservationInputModel();
    form.Language ??= Model.Tour.LanguageUsed;
    var paymentOptions = Model.PaymentOptions ?? Array.Empty<PaymentOptionDto>();
    var accommodationOptions = Model.AccommodationOptions ?? Array.Empty<string>();
}

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <h4 class="card-title">Need to know</h4>
        <ul class="list_style">
            <li>Category: @Model.Tour.CategoryString</li>
            <li>Language: @Model.LanguageLabel</li>
            @if (Model.ActiveDayNames.Any())
            {
                <li>Operates: @string.Join(", ", Model.ActiveDayNames)</li>
            }
            <li>Duration: @Model.Tour.DurationHours hour(s)</li>
        </ul>
        <a href="@Url.Action("Category", "Home", new { category = Model.Tour.Category })" class="btn theme_btn button_hover btn-block">More @Model.Tour.CategoryString Tours</a>
    </div>
</div>

<div class="card border-0 shadow-sm booking-card">
    <div class="card-body">
        <h4 class="card-title">Reserve your tour</h4>
        <p class="text-muted small mb-4">Complete the three quick steps to secure your seats and receive payment instructions.</p>

        @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
        {
            <div class="alert alert-danger" role="alert">@Model.ErrorMessage</div>
        }
        @if (!string.IsNullOrWhiteSpace(Model.SuccessMessage))
        {
            <div class="alert alert-success" role="alert">@Model.SuccessMessage</div>
        }

        <form asp-action="BookTour"
              asp-controller="Home"
              method="post"
              novalidate
              class="booking-form"
              data-book-action="@Url.Action("BookTour", "Home")"
              data-tour-id="@Model.Tour.Id"
              data-tour-name="@Model.Tour.TourName"
              data-adult-price="@Model.Tour.Price"
              data-child-price="@Model.Tour.KinderPrice"
              data-infant-price="@Model.Tour.InfantPrice"
              data-total-hint-empty="Add guests to see your estimated total."
              data-total-hint-ready="Proceed to payment to receive confirmation details in your inbox."
              data-paypal-enabled="@Model.PayPal.Enabled.ToString().ToLowerInvariant()"
              data-paypal-base-url="@Model.PayPal.BaseUrl"
              data-paypal-email="@Model.PayPal.BusinessEmail"
              data-paypal-currency="@Model.PayPal.Currency"
              data-paypal-return="@Model.PayPal.ReturnUrl"
              data-paypal-cancel="@Model.PayPal.CancelUrl">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Form.TourId" />
            <input type="hidden" name="TourId" value="@Model.Tour.Id" />
            <input type="hidden" asp-for="Form.Language" />
            <input type="hidden" asp-for="Form.PaymentReference" />
            <input type="hidden" asp-for="Form.PayWithPayPal" />

            <div asp-validation-summary="ModelOnly" class="text-danger small mb-3"></div>

            <div class="booking-progress d-flex justify-content-between mb-4">
                <div class="booking-progress-step" data-step-index="0">
                    <span class="badge badge-pill badge-primary mr-2">1</span> Guests
                </div>
                <div class="booking-progress-step text-muted" data-step-index="1">
                    <span class="badge badge-pill badge-secondary mr-2">2</span> Traveller details
                </div>
                <div class="booking-progress-step text-muted" data-step-index="2">
                    <span class="badge badge-pill badge-secondary mr-2">3</span> Payment
                </div>
            </div>

            <div class="booking-step" data-step="0">
                <div class="form-group">
                    <label asp-for="Form.PreferredDate">Choose your tour date</label>
                    @{
                        var earliestDate = DateTime.UtcNow.Date.AddDays(1).ToString("yyyy-MM-dd");
                    }
                    <input asp-for="Form.PreferredDate" type="date" class="form-control" min="@earliestDate" />
                    <small class="form-text text-muted">Pick a date at least one day from now, or leave empty if flexible.</small>
                    <span asp-validation-for="Form.PreferredDate" class="text-danger small"></span>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label asp-for="Form.Adults"></label>
                        <input asp-for="Form.Adults" type="number" class="form-control js-booking-input js-booking-adults" min="1" placeholder="Adults" />
                        <small class="form-text text-muted">Enter number of guests aged 12+</small>
                        <span asp-validation-for="Form.Adults" class="text-danger small"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label asp-for="Form.Children"></label>
                        <input asp-for="Form.Children" type="number" class="form-control js-booking-input js-booking-children" min="0" placeholder="Children" />
                        <small class="form-text text-muted">Guests aged 3â€“11</small>
                        <span asp-validation-for="Form.Children" class="text-danger small"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label asp-for="Form.Infants"></label>
                        <input asp-for="Form.Infants" type="number" class="form-control js-booking-input js-booking-infants" min="0" placeholder="Infants" />
                        <small class="form-text text-muted">Guests under 3</small>
                        <span asp-validation-for="Form.Infants" class="text-danger small"></span>
                    </div>
                </div>

                <div class="alert alert-light border mt-3" id="reservation-summary">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="mb-0">Estimated total for your group</span>
                        <strong class="h5 mb-0">â‚¬<span id="reservation-total-value">@Model.EstimatedTotal</span></strong>
                    </div>
                    <small class="text-muted d-block" id="reservation-total-hint">Add guests to see your estimated total.</small>
                </div>

                <button type="button" class="btn theme_btn button_hover btn-block mt-3" data-next-step>Continue</button>
            </div>

            <div class="booking-step d-none" data-step="1">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label asp-for="Form.FirstName"></label>
                        <input asp-for="Form.FirstName" class="form-control" placeholder="@(Model.Form.Language switch
                        {
                            "de" => "Vorname",
                            "fa" => "Ù†Ø§Ù…",
                            "ru" => "Ð˜Ð¼Ñ",
                            "pl" => "ImiÄ™",
                            "ar" => "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„",
                            _ => "First name"
                        })" />
                        <span asp-validation-for="Form.FirstName" class="text-danger small"></span>
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="Form.LastName"></label>
                        <input asp-for="Form.LastName" class="form-control" placeholder="@(Model.Form.Language switch
                        {
                            "de" => "Nachname",
                            "fa" => "Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ",
                            "ru" => "Ð¤Ð°Ð¼Ð¸Ð»Ð¸Ñ",
                            "pl" => "Nazwisko",
                            "ar" => "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©",
                            _ => "Last name"
                        })" />
                        <span asp-validation-for="Form.LastName" class="text-danger small"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Form.CustomerEmail"></label>
                    <input asp-for="Form.CustomerEmail" class="form-control" placeholder="Confirmation email" />
                    <span asp-validation-for="Form.CustomerEmail" class="text-danger small"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Form.CustomerPhone"></label>
                    <div class="input-group phone-input-group">
                        <div class="input-group-prepend dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle phone-country-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="phone-flag mr-2" data-phone-flag>ðŸ‡¹ðŸ‡·</span>
                                <span class="phone-country-code" data-phone-code>+90</span>
                            </button>
                            <div class="dropdown-menu phone-country-menu" data-phone-country-menu></div>
                        </div>
                        <input asp-for="Form.CustomerPhone"
                               class="form-control phone-number-input"
                               placeholder="WhatsApp or mobile number"
                               autocomplete="tel"
                               inputmode="tel"
                               data-phone-input />
                    </div>
                    <small class="form-text text-muted">Pick your country code or type it to auto-detect the flag.</small>
                    <span asp-validation-for="Form.CustomerPhone" class="text-danger small"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Form.HotelName">Hotel or accommodation</label>
                    <input asp-for="Form.HotelName"
                           class="form-control"
                           id="hotelField"
                           list="hotelList"
                           placeholder="Start typing to search or pick from the list"
                           value='@((string.IsNullOrWhiteSpace(form.HotelName) || string.Equals(form.HotelName, "Select Your Hotel", StringComparison.OrdinalIgnoreCase)) ? string.Empty : form.HotelName)' />
                    <datalist id="hotelList">
                        @foreach (var option in accommodationOptions)
                        {
                            <option value="@option"></option>
                        }
                    </datalist>
                    <small class="form-text text-muted">Type a few letters to find your hotel or pick from the suggestions.</small>
                    <span asp-validation-for="Form.HotelName" class="text-danger small"></span>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label asp-for="Form.RoomNumber"></label>
                        <input asp-for="Form.RoomNumber" class="form-control" placeholder="Room number (optional)" />
                        <span asp-validation-for="Form.RoomNumber" class="text-danger small"></span>
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="Form.PickupLocation">Extra pickup notes</label>
                        <input asp-for="Form.PickupLocation" class="form-control" placeholder="Lobby meeting time or alternate pickup" />
                        <span asp-validation-for="Form.PickupLocation" class="text-danger small"></span>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" data-prev-step>Back</button>
                    <button type="button" class="btn theme_btn button_hover" data-next-step>Continue</button>
                </div>
            </div>

            <div class="booking-step d-none payment-step" data-step="2">
                <div class="form-group mb-3">
                    <label class="d-block">Payment method</label>
                    @if (paymentOptions.Any())
                    {
                        foreach (var option in paymentOptions)
                        {
                            var paymentId = $"payment-{option.Method}";
                            <div class="custom-control custom-radio mb-2">
                                <input class="custom-control-input" type="radio" id="@paymentId" name="Form.PaymentMethod" value="@option.Method" @(form.PaymentMethod == option.Method ? "checked" : null) />
                                <label class="custom-control-label" for="@paymentId">
                                    <strong>@option.DisplayName</strong>
                                    @if (option.Method == PaymentMethod.PayPal)
                                    {
                                        <span class="d-block small text-muted">Pay securely with PayPal</span>
                                    }
                                    else
                                    {
                                        <span class="d-block small text-muted">@option.AccountIdentifier</span>
                                    }
                                </label>
                                <p class="small text-muted mt-1 mb-0">@option.Instructions</p>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="small text-muted">Payment methods will be provided after booking confirmation.</p>
                    }
                    <span asp-validation-for="Form.PaymentMethod" class="text-danger small"></span>
                </div>

                @if (Model.PayPal.Enabled)
                {
                    <div class="alert alert-info paypal-box" id="paypalCheckoutContainer" style="display:none;">
                        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                            <div class="mr-md-3 mb-2 mb-md-0">
                                <strong>Instant PayPal checkout</strong>
                                <p class="small mb-0">Use PayPal for immediate confirmation once you review the amount.</p>
                            </div>
                            <button id="paypalCheckoutButton"
                                    type="button"
                                    class="btn btn-warning text-uppercase font-weight-bold disabled"
                                    aria-disabled="true"
                                    data-paypal-submit>
                                <i class="fa fa-paypal mr-2"></i> Pay with PayPal
                            </button>
                        </div>
                    </div>
                }

                <div class="alert alert-light summary-card">
                    <strong>Summary</strong>
                    <ul class="list-unstyled mb-0 small">
                        <li>Total guests: <span id="summary-total-guests">@((form.Adults + form.Children + form.Infants))</span></li>
                        <li>Estimated total: â‚¬<span id="summary-total-price">@Model.EstimatedTotal</span></li>
                    </ul>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4">
                    <button type="button" class="btn btn-outline-secondary" data-prev-step>Back</button>
                    <button type="submit" class="btn theme_btn button_hover px-4">Reserve now</button>
                </div>
            </div>
        </form>

        <hr class="my-4" />
        <p class="small mb-1">Prefer to talk?</p>
        <a href="mailto:info@tourantalya.com" class="btn btn-outline-primary btn-block">Email us</a>
        <a href="tel:+905013411029" class="btn btn-outline-secondary btn-block mt-2">Call +90 (501) 341 10 29</a>
    </div>
</div>
